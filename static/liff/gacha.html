<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塩爺のガチャ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .shiojii-bg {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .gacha-card {
            transition: transform 0.2s;
        }

        .gacha-card:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body class="shiojii-bg min-h-screen p-4 pb-20">
    <!-- Header -->
    <div class="glass-panel p-4 mb-4 text-center">
        <h1 class="text-xl font-bold text-gray-800">散財の時間よ♡</h1>
    </div>

    <!-- Shiojii Dialogue -->
    <div class="bg-white p-3 rounded-lg shadow mb-4 relative ml-4 mr-4">
        <div class="absolute -left-2 top-2 w-4 h-4 bg-white transform rotate-45"></div>
        <p id="shiojii-msg" class="text-sm text-gray-600">「さっさと引きなさいよ。<br>あんたの財布、軽そうねｗｗ」</p>
    </div>

    <!-- Gacha List -->
    <div id="gacha-list" class="space-y-4">
        <!-- Template -->
        <!--
        <div class="glass-panel p-4">
            <h2 class="font-bold">キャラガチャ</h2>
            <p class="text-sm text-gray-500 mb-2">1回 ¥300</p>
            <button class="w-full bg-pink-500 text-white py-2 rounded-lg font-bold">引く</button>
        </div>
        -->
        <p class="text-center text-gray-500">読み込み中...</p>
    </div>

    <!-- Results Modal -->
    <div id="result-modal"
        class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center relative">
            <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-400">✕</button>
            <h2 class="text-2xl font-bold mb-4 text-pink-500">結果発表～！</h2>
            <div id="result-content" class="space-y-2 mb-4">
                <!-- Items go here -->
            </div>
            <p id="result-msg" class="text-xs text-gray-500 italic mb-4">「あら、ゴミばっかり♡」</p>
            <button onclick="closeModal()" class="w-full bg-gray-200 py-2 rounded-lg">閉じる</button>
        </div>
    </div>

    <script>
        let userId = null;

        async function init() {
            try {
                await liff.init({ liffId: "{{ liff_id }}" });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    fetchGachas();
                } else {
                    alert('LINEでログインしてください');
                }
            } catch (err) {
                console.error(err);
                // Dev mock
                userId = 'dev_user';
                fetchGachas();
            }
        }

        async function fetchGachas() {
            try {
                const res = await fetch('/api/gacha/list');
                const gachas = await res.json();
                const container = document.getElementById('gacha-list');
                container.innerHTML = '';

                gachas.forEach(g => {
                    const el = document.createElement('div');
                    el.className = 'glass-panel p-4 flex flex-col items-center';
                    el.innerHTML = `
                        ${g.image_url ? `<img src="${g.image_url}" class="w-full h-32 object-cover rounded mb-2">` : ''}
                        <h2 class="font-bold text-lg">${g.name}</h2>
                        <p class="text-xs text-gray-500 mb-4">${g.description || ''}</p>
                        <button onclick="draw('${g.gacha_id}', ${g.cost}, '${g.currency}')" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition">
                            ${g.cost} ${g.currency} で引く
                        </button>
                    `;
                    container.appendChild(el);
                });
            } catch (e) {
                document.getElementById('gacha-list').innerHTML = '<p class="text-red-500 text-center">読み込み失敗</p>';
            }
        }

        async function draw(gachaId, cost, currency) {
            if (!confirm(`${cost} ${currency} 消費します。\nよろしいですか？（返品不可よ♡）`)) return;

            // Loading UI?

            try {
                const res = await fetch('/api/gacha/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, gachaId: gachaId, count: 1 })
                });
                const data = await res.json();

                if (data.success) {
                    showResult(data.items);
                } else {
                    alert('エラー: ' + data.message);
                }
            } catch (e) {
                alert('通信エラー');
            }
        }

        function showResult(items) {
            const container = document.getElementById('result-content');
            container.innerHTML = '';

            let hasRare = false;
            items.forEach(item => {
                if (['UR', 'SSR'].includes(item.rarity)) hasRare = true;
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 bg-gray-50 rounded border border-gray-100';
                div.innerHTML = `
                    <div class="w-12 h-12 bg-gray-300 rounded mr-3 overflow-hidden flex-shrink-0">
                        ${item.image_url ? `<img src="${item.image_url}" class="w-full h-full object-cover">` : '<span class="text-xs flex items-center justify-center h-full">No Img</span>'}
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-sm ${getRarityColor(item.rarity)}">[${item.rarity}] ${item.name}</p>
                        <p class="text-xs text-gray-400">NEW</p>
                    </div>
                `;
                container.appendChild(div);
            });

            // Shiojii reaction
            const msgEl = document.getElementById('result-msg');
            if (hasRare) {
                msgEl.innerText = "「チッ…運がいいわね。次は爆死しなさい。」";
            } else {
                msgEl.innerText = "「うぷぷｗ ゴミしか出ないの？ 可哀想～ｗｗ」";
            }

            document.getElementById('result-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
        }

        function getRarityColor(rarity) {
            if (rarity === 'UR') return 'text-red-500';
            if (rarity === 'SSR') return 'text-yellow-500';
            if (rarity === 'SR') return 'text-purple-500';
            return 'text-gray-700';
        }

        init();
    </script>
</body>

</html>